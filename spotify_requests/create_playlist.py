import spotipy

class SpotifyAPIError(Exception):
    """Custom exception for general Spotify API errors."""

def create_playlist(sp, playlist_name: str, song_uris: list[str]):
    '''Creates a playlist with the given name and adds the provided songs.'''    
    if not playlist_name:
        print("DEBUG: create_playlist - Playlist name is missing.")
        raise ValueError("Playlist name must be provided.")

    if not song_uris:
        print("DEBUG: create_playlist - No songs provided to add.")
        raise ValueError("At least one song URI must be provided.")

    try:
        print("DEBUG: create_playlist - Fetching current user ID.")
        user_id = sp.current_user()['id']

    except spotipy.SpotifyException as e:
        print(f"ERROR: create_playlist - Failed to get user ID: {e}")
        raise SpotifyAPIError(f"Spotify API Error getting user ID: {e.reason}") from e
    
    except Exception as e:
        print(f"ERROR: create_playlist - Unexpected error while fetching user ID: {e}")
        raise SpotifyAPIError(f"Unexpected error fetching user ID: {e}") from e

    try:
        print(f"DEBUG: create_playlist - Creating playlist '{playlist_name}' for user '{user_id}'.")
        playlist = sp.user_playlist_create(
            user=user_id,
            name=playlist_name,
            public=True,
            collaborative=False,
            description='Generated by Dive Back In Time app'
        )
        print(f"DEBUG: create_playlist - Playlist created with ID: {playlist['id']}")

    except spotipy.SpotifyException as e:
        print(f"ERROR: create_playlist - Failed to create playlist: {e}")
        raise SpotifyAPIError(f"Spotify API Error creating playlist: {e.reason}") from e
    
    except Exception as e:
        print(f"ERROR: create_playlist - Unexpected error while creating playlist: {e}")
        raise SpotifyAPIError(f"Unexpected error creating playlist: {e}") from e

    try:
        print(f"DEBUG: create_playlist - Adding {len(song_uris)} tracks to playlist.")
        sp.user_playlist_add_tracks(user=user_id, playlist_id=playlist['id'], tracks=song_uris)
        print("DEBUG: create_playlist - Tracks added successfully.")

    except spotipy.SpotifyException as e:
        print(f"ERROR: create_playlist - Failed to add tracks: {e}")
        raise SpotifyAPIError(f"Spotify API Error adding tracks: {e.reason}") from e
    
    except Exception as e:
        print(f"ERROR: create_playlist - Unexpected error while adding tracks: {e}")
        raise SpotifyAPIError(f"Unexpected error adding tracks: {e}") from e
